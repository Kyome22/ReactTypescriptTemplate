<!-- title:AWSのEC2インスタンスでNode.jsのアプリを作った時のメモ -->
#はじめに
Node.jsで書いたアプリをローカルだけでなくサーバーで動かしたかった．
AWSのEC2の無料枠を使ってうまいことやりたい．
一旦リンクとつまづいたところをメモしておく（後日整形して綺麗にまとめたい）

#EC2インスタンス立ち上げ
- サービス -> コンピューティング -> EC2 -> インスタンスの作成
- Amazon Linux AMI 2017.09.1 ~ のやつ選択
- インスタンスのセキュリティグループ設定を編集 -> インバウンドにHTTPを追加

##SSH / SFTP 接続の仕方
- pemファイルをダウンロード（なぜか.txtなので.pemにする）
- `chmod 400 [ファイル名].pem`をやっておく

```terminal:
$ ssh -i [.pemへの絶対パス] ec2-user@[パブリック DNS (IPv4)]
$ sftp -i [.pemへの絶対パス] ec2-user@[パブリック DNS (IPv4)]
```

##SSH接続時，$より前の部分の名前を変える方法
`/home/ec2-user`ディレクトリの中の`.bashrc`を編集

```shell:
# .bashrc

PS1="\[\033[36m\]ユーザー名とか:\W $ \[\033[0m\]"

# Source global definitions
if [ -f /etc/bashrc ]; then
	. /etc/bashrc
fi

# User specific aliases and functions
```

こんな感じにする． 
`# Source global ~`より後の部分より先に`PS1~`のコマンドを書かないと反映されない

#SSH接続してとりあえずやること
- `$ sudo yum update` システムアプデ
- `$ sudo yum -y install gcc-c++` gccインスコ
- `$ sudo yum -y install git` gitインスコ
- `$ git clone https://github.com/creationix/nvm.git ~/.nvm` nvmインスコ
- nvmのパスを通す

#node.jsの導入
- `$ nvm install [バージョン番号]`
- `$ nvm use v[バージョン番号]`

#forever.jsの導入
`$ npm install forever -g`

##Nodeのデーモン化
- `$ forever start [nodeファイル.js]` 開始
- `$ forever stop [nodeファイル.js] or ジョブ番号` 停止
- `$ forever list` ジョブ一覧

##Apache2.4の導入
```shell:
yum list | grep httpd24
sudo yum install -y httpd24
sudo service httpd start
```
#バーチャルホストの設定
- ドメインを手に入れる（お名前.comを使う場合は）
- Apacheをセットアップする
 - `$ sudo yum install httpd`
 - `$ sudo chkconfig httpd on`
- `/etc/httpd/conf/httpd.conf`を編集

末尾に追加

```shell:
NameVirtualHost *:80
<VirtualHost *:80>
    #DocumentRoot /var/www/[ディレクトリパス]
    ServerName [とったドメイン]
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
</VirtualHost>
```

3000はnodeアプリを動かすポート番号

Apacheの再起動
`sudo service httpd restart`

##ImageMagickのインストール
[ImageMagickの最新版をEC2にインストールする](https://qiita.com/tak74/items/ad319e5af95dbd8fdf31)

#参考
[AWS EC2でNodeを動作させる](https://qiita.com/oishihiroaki/items/bc663eb1282d87c46e97)
[Linux上でNode.jsを常駐化する方法](https://qiita.com/koheishingai/items/264887a447aca1f8eac3)
[Amazon EC2でnode.js,Expressアプリケーションを立ち上げる](https://qiita.com/Sugima/items/670924901e38cf9eb84a)

[Amazon LinuxにApacheをセットアップする方法](http://promamo.com/?p=2924)
[[Sy] Amazon Linux + Apache2.4系 でのバーチャルホストの設定方法](https://utano.jp/entry/2016/10/amazon-linux-apache-24-virtualhost/)
